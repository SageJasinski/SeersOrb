{% extends "base.html" %}

{% block title %}My Decks - Seer's Orb{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1 class="page-title">üìÅ My Decks</h1>
        <p class="page-subtitle">
            Manage your deck collection
        </p>
    </div>

    <div class="decks-actions mb-lg">
        <a href="{{ url_for('deck.deck_builder') }}" class="btn btn-primary btn-lg">
            <span>‚ûï</span> Create New Deck
        </a>
        <button class="btn btn-secondary" id="import-deck-btn">
            <span>üì•</span> Import Deck
        </button>
    </div>

    <div id="decks-grid" class="decks-grid">
        <div class="loading-state">
            <div class="loading-spinner"></div>
            <p>Loading decks...</p>
        </div>
    </div>
</div>

<!-- Import Modal -->
<div id="import-modal" class="modal hidden">
    <div class="modal-content">
        <div class="modal-header">
            <h3>Import Deck</h3>
            <button class="btn btn-ghost btn-sm" id="close-import">‚úï</button>
        </div>
        <div class="modal-body">
            <div class="form-group">
                <label class="form-label">Deck Name</label>
                <input type="text" id="import-deck-name" class="form-input" placeholder="My Imported Deck">
            </div>
            <div class="form-group">
                <label class="form-label">Format</label>
                <select id="import-deck-format" class="form-select">
                    <option value="commander">Commander</option>
                    <option value="standard">Standard</option>
                    <option value="modern">Modern</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Deck List (one card per line, format: "1 Card Name")</label>
                <textarea id="import-deck-text" class="form-textarea" rows="10" placeholder="1 Sol Ring
1 Command Tower
4 Lightning Bolt"></textarea>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" id="cancel-import">Cancel</button>
            <button class="btn btn-primary" id="confirm-import">Import</button>
        </div>
    </div>
</div>

<style>
    .decks-actions {
        display: flex;
        gap: var(--space-md);
    }

    .decks-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: var(--space-lg);
    }

    .loading-state {
        grid-column: 1 / -1;
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: var(--space-2xl);
        color: var(--color-text-muted);
    }

    .deck-card {
        background: var(--color-bg-card);
        border: 1px solid var(--color-bg-tertiary);
        border-radius: var(--radius-lg);
        padding: var(--space-lg);
        transition: all var(--transition-fast);
    }

    .deck-card:hover {
        border-color: var(--color-accent);
        transform: translateY(-2px);
    }

    .deck-card-header {
        display: flex;
        justify-content: space-between;
        align-items: start;
        margin-bottom: var(--space-md);
    }

    .deck-card-name {
        font-size: 1.25rem;
        font-weight: 600;
        margin: 0;
    }

    .deck-card-format {
        font-size: 0.75rem;
        padding: 2px 8px;
        background: var(--color-accent-subtle);
        color: var(--color-accent);
        border-radius: var(--radius-full);
        text-transform: uppercase;
    }

    .deck-card-stats {
        display: flex;
        gap: var(--space-lg);
        margin-bottom: var(--space-md);
        color: var(--color-text-muted);
        font-size: 0.875rem;
    }

    .deck-card-colors {
        display: flex;
        gap: var(--space-xs);
        margin-bottom: var(--space-md);
    }

    .deck-card-actions {
        display: flex;
        gap: var(--space-sm);
    }

    .modal {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: var(--z-modal);
    }

    .modal.hidden {
        display: none;
    }

    .modal-content {
        background: var(--color-bg-secondary);
        border-radius: var(--radius-lg);
        width: 100%;
        max-width: 500px;
        max-height: 80vh;
        overflow-y: auto;
    }

    .modal-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: var(--space-lg);
        border-bottom: 1px solid var(--color-bg-tertiary);
    }

    .modal-body {
        padding: var(--space-lg);
    }

    .modal-footer {
        display: flex;
        justify-content: flex-end;
        gap: var(--space-sm);
        padding: var(--space-lg);
        border-top: 1px solid var(--color-bg-tertiary);
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // Load decks
    async function loadDecks() {
        const grid = document.getElementById('decks-grid');

        try {
            const data = await api('/decks');

            if (!data.decks || data.decks.length === 0) {
                grid.innerHTML = `
                <div class="empty-state" style="grid-column: 1 / -1; text-align: center; padding: 4rem;">
                    <span style="font-size: 4rem; opacity: 0.3;">üìÅ</span>
                    <p style="margin: 1rem 0; color: var(--color-text-muted);">No decks yet</p>
                    <a href="{{ url_for('deck.deck_builder') }}" class="btn btn-primary">Create Your First Deck</a>
                </div>
            `;
                return;
            }

            grid.innerHTML = data.decks.map(deck => `
            <div class="deck-card" data-deck-id="${deck.id}">
                <div class="deck-card-header">
                    <h3 class="deck-card-name">${deck.name}</h3>
                    <span class="deck-card-format">${deck.format}</span>
                </div>
                <div class="deck-card-stats">
                    <span>üÉè ${deck.card_count} cards</span>
                    <span>üìÖ ${new Date(deck.updated_at).toLocaleDateString()}</span>
                </div>
                <div class="deck-card-actions">
                    <a href="/deck/builder/${deck.id}" class="btn btn-primary btn-sm">Edit</a>
                    <a href="/deck/graph/${deck.id}" class="btn btn-secondary btn-sm">Graph</a>
                    <button class="btn btn-danger btn-sm" onclick="deleteDeck('${deck.id}')">Delete</button>
                </div>
            </div>
        `).join('');
        } catch (error) {
            grid.innerHTML = `<p class="text-muted">Error loading decks: ${error.message}</p>`;
        }
    }

    async function deleteDeck(id) {
        if (!confirm('Are you sure you want to delete this deck?')) return;

        try {
            await api(`/decks/${id}`, { method: 'DELETE' });
            showToast('Deck deleted', 'success');
            loadDecks();
        } catch (error) {
            showToast('Failed to delete: ' + error.message, 'error');
        }
    }

    // Import modal
    const modal = document.getElementById('import-modal');
    document.getElementById('import-deck-btn').addEventListener('click', () => modal.classList.remove('hidden'));
    document.getElementById('close-import').addEventListener('click', () => modal.classList.add('hidden'));
    document.getElementById('cancel-import').addEventListener('click', () => modal.classList.add('hidden'));

    document.getElementById('confirm-import').addEventListener('click', async () => {
        const name = document.getElementById('import-deck-name').value || 'Imported Deck';
        const format = document.getElementById('import-deck-format').value;
        const text = document.getElementById('import-deck-text').value;

        try {
            await api('/decks/import', {
                method: 'POST',
                body: { name, format, deck_text: text }
            });
            showToast('Deck imported!', 'success');
            modal.classList.add('hidden');
            loadDecks();
        } catch (error) {
            showToast('Import failed: ' + error.message, 'error');
        }
    });

    // Init
    loadDecks();
</script>
{% endblock %}